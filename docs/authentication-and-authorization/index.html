<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Authentication and authorization · ReSolve</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;setting-up-authentication&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#setting-up-authentication&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Setting up Authentication&lt;/h1&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Authentication and authorization · ReSolve"/><meta property="og:type" content="website"/><meta property="og:url" content="https://reimagined.github.io/resolve/index.html"/><meta property="og:description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;setting-up-authentication&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#setting-up-authentication&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Setting up Authentication&lt;/h1&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/resolve/undefined"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/resolve/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/resolve/"><img class="logo" src="/resolve/img/resolve.svg" alt="ReSolve"/><h2 class="headerTitleWithLogo">ReSolve</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/resolve/docs/" target="_self">Docs Index</a></li><li class=""><a href="/resolve/docs/faq" target="_self">FAQ</a></li><li class=""><a href="/resolve/docs/troubleshooting" target="_self">Troubleshooting</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Authentication and authorization</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="setting-up-authentication"></a><a href="#setting-up-authentication" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up Authentication</h1>
<p>ReSolve relies on the <a href="http://www.passportjs.org/">Passport.js</a> library for authentication.</p>
<p>To specify authentication strategies for your reSolve application, register the path to a file defining these strategies in the <strong>auth.strategies</strong> config section:</p>
<!-- prettier-ignore-start -->
[embedmd]:# (../examples/hacker-news/config.app.js /auth: \{/ /\}/)
```js
auth: {
    strategies: 'auth/local_strategy.js'
  }
```
<!-- prettier-ignore-end -->
<p>The specified file should export an array. Each item in this array defines a strategy by providing a strategy constructor function along with a set of strategy options. You can define strategies using the following general format:</p>
<pre><code class="hljs css language-js"><span class="hljs-comment">// ./auth/index.js</span>
<span class="hljs-keyword">import</span> LocalStrategy <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-local'</span>
<span class="hljs-keyword">const</span> jwtSecret = process.env.JWT_SECRET
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">strategyConstructor</span>: <span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LocalStrategy(
        {
          <span class="hljs-attr">customStrategyOption1</span>: <span class="hljs-string">"customStrategyOption1"</span>,
          <span class="hljs-attr">customStrategyOption2</span>: <span class="hljs-string">"customStrategyOption2"</span>,
          <span class="hljs-attr">passReqToCallback</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-keyword">async</span> (req, username, password, done) =&gt; {
          <span class="hljs-keyword">try</span> {
            done(<span class="hljs-literal">null</span>, { username }, jwtSecret)
          } <span class="hljs-keyword">catch</span> (error) {
            done(error)
          }
        }
      )
    },
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">route</span>: {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/auth/local'</span>,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>
      }
    }
  }
]
</code></pre>
<p>For a comprehensive code sample, refer to the <a href="https://github.com/reimagined/resolve/tree/master/examples/hacker-news">Hacker News</a> example application.</p>
<h1><a class="anchor" aria-hidden="true" id="using-3rd-party-auth-services"></a><a href="#using-3rd-party-auth-services" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using 3rd-Party Auth Services</h1>
<p>You can implement authentication via 3rd-party services in the same way, in which you implement local authentication. To implement authentication for a particular service, use corresponding Passport modules, e.g., <strong>passport-google</strong> or <strong>passport-facebook</strong>.</p>
<h1><a class="anchor" aria-hidden="true" id="making-your-own-user-registry"></a><a href="#making-your-own-user-registry" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making Your Own User Registry</h1>
<p>If you prefer to store a user registry in your application, or if you use a third-party authentication service but need to store additional information that is not provided by this service (e.g., roles or permissions), then you can just stick to the standard event sourcing approach:</p>
<ul>
<li>Add a User aggregate to accept commands and generate events related to managing a user registry</li>
<li>Create a read model and use it to look up a current user's information during logging in and put this information into a JWT (JSON Web Token)</li>
</ul>
<p>For example, if you want to grant permissions to a user, you can write something like this:</p>
<p>Write side. &quot;user&quot; aggregate:</p>
<p>user.commands.js:</p>
<pre><code class="hljs css language-js">...
grantPermission: <span class="hljs-function">(<span class="hljs-params">state, command</span>) =&gt;</span> {
   <span class="hljs-keyword">const</span> {<span class="hljs-attr">payload</span>: {<span class="hljs-attr">permission</span>: permissionToGrant }} = command;

   <span class="hljs-keyword">if</span> (state.permissions.includes(permissionToGrant)) {
       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"permission aleady granted"</span>)
   }
   <span class="hljs-keyword">return</span> {
       <span class="hljs-attr">type</span>: PERMISSION_GRANTED,
       <span class="hljs-attr">payload</span>: {
           <span class="hljs-attr">permission</span>: permissionToGrant
       }
   }
}
...
</code></pre>
<p>user.projection.js:</p>
<pre><code class="hljs css language-js">...
[PERMISSION_GRANTED]: <span class="hljs-function">(<span class="hljs-params">state, {payload: {permission}}</span>) =&gt;</span> ({
    ...state,
    <span class="hljs-attr">permissions</span>: [...state.permissions, permission]
})
...
</code></pre>
<p>Read side. &quot;users&quot; read model:
users.projection.js:</p>
<pre><code class="hljs css language-js">...
[PERMISSION_GRANTED]: <span class="hljs-keyword">async</span> (store, {aggregateId, <span class="hljs-attr">payload</span>:{permission}}) =&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> store.findOne(<span class="hljs-string">'Users'</span>, { <span class="hljs-attr">id</span>: aggregateId })
    <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-keyword">await</span> store.update(
          <span class="hljs-string">'Users'</span>,
          { <span class="hljs-attr">id</span>: aggregateId },
          { <span class="hljs-attr">$set</span>: {<span class="hljs-attr">permissions</span>: [...user.permissions, permission]}}
        )
    }
}
...
</code></pre>
<p>users.resolvers.js:</p>
<pre><code class="hljs css language-js">...
userById: <span class="hljs-keyword">async</span>(store, {id}) =&gt; store.findOne(<span class="hljs-string">'Users'</span>, {id})
...
</code></pre>
<p>Now, upon login you can query Users read model and store user record with its permissions in the JWT Token:</p>
<pre><code class="hljs css language-js">...
const user = <span class="hljs-keyword">await</span> resolve.executeQuery({
  <span class="hljs-attr">modelName</span>: <span class="hljs-string">'Users'</span>,
  <span class="hljs-attr">resolverName</span>: <span class="hljs-string">'userById'</span>,
  <span class="hljs-attr">resolverArgs</span>: { id }
})
<span class="hljs-keyword">if</span> (user)
  <span class="hljs-keyword">return</span> jwt.sign(user, jwtSecret)
...
</code></pre>
<h1><a class="anchor" aria-hidden="true" id="using-jwt-for-command-and-query-authorization"></a><a href="#using-jwt-for-command-and-query-authorization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using JWT for Command and Query Authorization</h1>
<p>Every command and query handler accepts a JSON Web Token (JWT) obtained during the authentication process. This JWT contains an object that was returned by authentication function, or an empty object <code>{}</code> if current user is not logged in.</p>
<p>A JWT is signed, so it cannot be forged by an attacker, without knowing a secret that was used for token creation. The token can be decoded and verified using the same secret that was used for its creation:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> { <span class="hljs-attr">id</span>: userId } = jwt.verify(jwtToken, jwtSecret)
</code></pre>
<p>You can store any information in a JWT. For instance, during authentication, you can look up a
user's permissions and add them to the token. Then, you can check for the user's permissions on a command or query execution as shown below:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> { <span class="hljs-attr">id</span>: userId, permissions } = jwt.verify(jwtToken, jwtSecret);

<span class="hljs-keyword">if</span> (permissions &amp;&amp; permissions.includes(<span class="hljs-string">"admin"</span>)) {
...
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Access denied"</span>);
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/resolve/" class="nav-home"><img src="/resolve/img/resolve.svg" alt="ReSolve" width="66" height="58"/></a><div><h5>Docs</h5><a href="/resolve/">Documentation Index</a></div><div><h5>Community</h5><a href="http://stackoverflow.com/questions/resolvejs/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://stackoverflow.com/questions/tagged/resolvejs" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="https://github.com/reimagined/resolve">GitHub</a><a class="github-button" href="https://github.com/reimagined/resolve" data-icon="octicon-star" data-count-href="/reimagined/resolve/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2018 reimagined</section></footer></div></body></html>